<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CaptiMark - Caption Generator</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/fontawesome.css') }}">
</head>
<body>
<div class="sub-header">
  <div class="container">
    <ul class="left-info">
      <li><a href="#"><i class="fa fa-clock-o"></i>Mon‚ÄìFri 09:00‚Äì05:00</a></li>
      <li><a href="#"><i class="fa fa-phone"></i>1234567890</a></li>
    </ul>
    <ul class="right-icons">
      <li><a href="#"><i class="fa fa-facebook"></i></a></li>
      <li><a href="#"><i class="fa fa-twitter"></i></a></li>
      <li><a href="#"><i class="fa fa-linkedin"></i></a></li>
    </ul>
  </div>
</div>

    <header class="">
      <nav class="navbar navbar-expand-lg">
        <div class="container">
          <a class="navbar-brand" href="{{ url_for('home') }}"><h2>Capti - on</h2></a>
          <div class="collapse navbar-collapse" id="navbarResponsive">
            <ul class="navbar-nav ml-auto">
              <li class="nav-item active">
                <a class="nav-link" href="{{ url_for('home') }}">Home
                  <span class="sr-only"></span>
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{{ url_for('about') }}">About Us</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{{ url_for('services') }}">Our Services</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{{ url_for('capti') }}">Image Captioning</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{{ url_for('contact') }}">Contact Us</a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
    </header>
    
    <br><br>

  <main class="container1">
    <!-- Left Section -->
    <section class="form-section">
      <h3>Generate Captions</h3>
      <br>
      <form action="/capti" method="POST" enctype="multipart/form-data">
        <div class="upload-box">
          <label for="image" class="upload-area">
            <p>üì§ Click or drag & drop to upload</p>
            <p class="small">PNG, JPG, or WEBP</p>
          </label>
          <input type="file" id="image" name="image" accept="image/*" required />
        </div>

        <div class="form-group">
          <label>Product Description</label>
          <textarea name="description" placeholder="e.g., Hand-crafted leather boots, waterproof, available in brown and black." required></textarea>
        </div>
        <!--<div class="form-group">
          <label>Select Model:</label>
          <input type="radio" name="model_choice" value="gemini" checked> Gemini<br>
          <input type="radio" name="model_choice" value="h5"> My H5 Model
        </div> -->
        <div class="form-row">
          <div class="form-group">
            <label>Tone of Voice</label>
            <select name="tone">
              <option>Professional</option>
              <option>Friendly</option>
              <option>Playful</option>
              <option>Persuasive</option>
            </select>
          </div>
          <div class="form-group">
            <label>Language</label>
            <select name="language">
              <option>English</option>
              <option>Hindi</option>
              <option>Spanish</option>
              <option>French</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Caption Platform</label>
            <select name="platform">
              <option>Instagram</option>
              <option>Facebook</option>
              <option>Twitter</option>
              <option>LinkedIn</option>
            </select>
          </div>
          <div class="form-group">
            <label>Ad Platform</label>
            <select name="adplatform">
              <option>Email</option>
              <option>Google Ads</option>
              <option>Meta Ads</option>
              <option>Website</option>
            </select>
          </div>
        </div>

        <button class="generate-btn" type="submit">Generate Content</button>
      </form>
    </section>

    <!-- Right Section -->
    <section class="result-section">
      <div class="result-box">
        {% if caption %}
          <h3>Generated Caption:</h3>
          <p>{{ caption }}</p>
        {% else %}
          <h3>Your results will appear here</h3>
          <p>Fill out the form and upload an image to get started.</p>
        {% endif %}
      </div>
    </section>
  </main>
      <!-- Bootstrap core JavaScript -->

  <!-- ===== Floating Chatbot  ===== -->
<!-- Inline SVG typing-bubble icon (scalable) -->
<div id="chatbot-root">
  <button id="chatbot-button" aria-label="Open Chat">
    <!-- animated typing bubble SVG -->
    <svg id="chat-svg" viewBox="0 0 24 24" width="28" height="28" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <path d="M3 12a9 9 0 0 1 9-9h0a9 9 0 0 1 0 18H9l-4 3V12z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
      <!-- three animated dots -->
      <g id="dots" fill="currentColor">
        <circle cx="8.8" cy="11.4" r="0.9" opacity="0.9">
          <animate attributeName="r" values="0.9;1.8;0.9" dur="1s" repeatCount="indefinite" begin="0s" />
        </circle>
        <circle cx="12" cy="11.4" r="0.9" opacity="0.9">
          <animate attributeName="r" values="0.9;1.9;0.9" dur="1s" repeatCount="indefinite" begin="0.12s" />
        </circle>
        <circle cx="15.2" cy="11.4" r="0.9" opacity="0.9">
          <animate attributeName="r" values="0.9;1.8;0.9" dur="1s" repeatCount="indefinite" begin="0.24s" />
        </circle>
      </g>
    </svg>
    <!-- GIF fallback (hidden by default) -->
    <img id="chat-gif" src="/static/chat-typing.gif" alt="Chat" style="display:none;width:36px;height:36px;border-radius:8px;">
  </button>

  <div id="chatbot-popup" role="dialog" aria-label="Chatbot window">
    <div id="chatbar">
      <div id="chat-title">Caption Assistant</div>
      <div id="chat-controls">
        <button id="minimize-btn" title="Minimize">‚Äî</button>
        <button id="close-btn" title="Close">‚úï</button>
      </div>
    </div>
    <iframe id="chatbot-iframe" src="{{ url_for('chatbot') }}"></iframe>
    <!-- Resize handle (bottom-right) -->
    <div id="resize-handle" aria-hidden="true"></div>
  </div>
</div>

<!-- ===== Styles ===== -->
<style>
  :root {
    --chat-bg: #ffffff;
    --chat-accent: #4f46e5; /* default accent (can match Tailwind indigo-600) */
    --chat-text: #111827;
    --chat-muted: #6b7280;
    --chat-border: rgba(0,0,0,0.08);
    --chat-width: 380px;
    --chat-height: 520px;
  }

  /* dark mode */
  @media (prefers-color-scheme: dark) {
    :root {
      --chat-bg: #0f172a;
      --chat-accent: #7c3aed;
      --chat-text: #e6edf3;
      --chat-muted: #9ca3af;
      --chat-border: rgba(255,255,255,0.06);
    }
  }

  /* container */
  #chatbot-root { position: fixed; z-index: 10000; right: 20px; bottom: 20px; font-family: Inter, system-ui, Arial, sans-serif; }

  /* button */
  #chatbot-button {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 64px;
    height: 64px;
    border-radius: 999px;
    border: none;
    cursor: pointer;
    background: linear-gradient(135deg,var(--chat-accent), #2b6ff6);
    color: white;
    box-shadow: 0 8px 24px rgba(16,24,40,0.25);
    transition: transform .18s ease, box-shadow .18s ease;
  }
  #chatbot-button:hover { transform: translateY(-4px) scale(1.04); box-shadow: 0 12px 34px rgba(16,24,40,0.32); }
  #chatbot-button:active { transform: translateY(-1px); }

  #chat-svg { pointer-events: none; }
  #chat-gif { pointer-events: none; }

  /* popup */
  #chatbot-popup {
    position: fixed;
    right: 20px;
    bottom: 100px;
    width: var(--chat-width);
    height: var(--chat-height);
    background: var(--chat-bg);
    border-radius: 12px;
    border: 1px solid var(--chat-border);
    box-shadow: 0 18px 50px rgba(2,6,23,0.35);
    overflow: hidden;
    display: none;
    resize: both;          /* native resize handle (works in many browsers) */
    overflow: auto;
    touch-action: none;    /* help dragging on touch */
  }

  /* glow animation when reply arrives */
  #chatbot-popup.reply-anim {
    animation: glowPulse 1.1s ease;
    box-shadow: 0 20px 60px rgba(124,58,237,0.18);
  }
  @keyframes glowPulse {
    0% { box-shadow: 0 0 0 rgba(124,58,237,0.0); transform: translateY(0); }
    30% { box-shadow: 0 0 20px rgba(124,58,237,0.18); transform: translateY(-2px); }
    100% { box-shadow: 0 6px 30px rgba(2,6,23,0.18); transform: translateY(0); }
  }

  /* chatbar */
  #chatbar { display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding: 10px 12px; background: linear-gradient(180deg, rgba(0,0,0,0.03), transparent); border-bottom: 1px solid var(--chat-border);
    cursor: move; user-select: none;
  }
  #chat-title { font-weight: 600; color: var(--chat-text); }
  #chat-controls button { background: transparent; border: none; color: var(--chat-muted); font-size: 16px; cursor: pointer; padding: 6px; border-radius: 6px; }
  #chat-controls button:hover { background: rgba(0,0,0,0.04); }

  iframe#chatbot-iframe { width: 100%; height: calc(100% - 46px); border: none; display: block; }

  /* resizer handle bottom-right */
  #resize-handle { position: absolute; right: 6px; bottom: 6px; width: 18px; height: 18px; cursor: se-resize; border-radius: 4px; opacity: 0.6; }
  #resize-handle:after { content: ""; position:absolute; right:4px; bottom:4px; width:10px; height:10px; border-right:2px solid var(--chat-border); border-bottom:2px solid var(--chat-border); transform: rotate(0deg); }

  /* small screens: expand popup a little */
  @media (max-width: 480px) {
    #chatbot-popup { width: calc(100% - 32px); height: 66vh; right: 16px; bottom: 80px; }
    #chatbot-button { width: 56px; height: 56px; }
  }
</style>

<!-- ===== Script: toggle, drag, resize, receive reply message, play sound ===== -->
<script>
  (function () {
    const btn = document.getElementById("chatbot-button");
    const popup = document.getElementById("chatbot-popup");
    const iframe = document.getElementById("chatbot-iframe");
    const closeBtn = document.getElementById("close-btn");
    const minimizeBtn = document.getElementById("minimize-btn");
    const resizeHandle = document.getElementById("resize-handle");
    const chatbar = document.getElementById("chatbar");

    // toggle open/close
    btn.addEventListener("click", () => {
      popup.style.display = popup.style.display === "block" ? "none" : "block";
    });
    closeBtn.addEventListener("click", () => popup.style.display = "none");
    minimizeBtn.addEventListener("click", () => {
      popup.style.display = popup.style.display === "block" ? "none" : "block";
    });

    // drag logic
    let isDragging = false;
    let dragStart = {x:0, y:0};
    let popupStart = {x:0, y:0};
    function getPopupRect() { return popup.getBoundingClientRect(); }

    function pointerDown(e) {
      isDragging = true;
      dragStart = { x: e.clientX || e.touches[0].clientX, y: e.clientY || e.touches[0].clientY };
      const r = getPopupRect();
      popupStart = { x: r.right, y: r.bottom };
      popup.style.transition = "none";
      document.addEventListener("pointermove", pointerMove);
      document.addEventListener("pointerup", pointerUp);
    }
    function pointerMove(e) {
      if (!isDragging) return;
      const clientX = e.clientX || (e.touches && e.touches[0].clientX);
      const clientY = e.clientY || (e.touches && e.touches[0].clientY);
      const dx = dragStart.x - clientX;
      const dy = dragStart.y - clientY;

      // compute new positions (right & bottom)
      const newRight = (window.innerWidth - (popupStart.x - dx)) + "px";
      const newBottom = (window.innerHeight - (popupStart.y - dy)) + "px";
      popup.style.right = newRight;
      popup.style.bottom = newBottom;
    }
    function pointerUp() {
      isDragging = false;
      popup.style.transition = "";
      document.removeEventListener("pointermove", pointerMove);
      document.removeEventListener("pointerup", pointerUp);
    }
    // wire drag start on chatbar
    chatbar.addEventListener("pointerdown", pointerDown);

    // resizer (manual)
    let isResizing = false;
    let resizeStart = {};
    resizeHandle.addEventListener("pointerdown", (e) => {
      isResizing = true;
      resizeStart = { x: e.clientX, y: e.clientY, w: popup.offsetWidth, h: popup.offsetHeight };
      document.addEventListener("pointermove", doResize);
      document.addEventListener("pointerup", stopResize);
      e.preventDefault();
    });
    function doResize(e) {
      if (!isResizing) return;
      const dx = e.clientX - resizeStart.x;
      const dy = e.clientY - resizeStart.y;
      const newW = Math.max(280, resizeStart.w + dx);
      const newH = Math.max(320, resizeStart.h + dy);
      popup.style.width = newW + "px";
      popup.style.height = newH + "px";
    }
    function stopResize() {
      isResizing = false;
      document.removeEventListener("pointermove", doResize);
      document.removeEventListener("pointerup", stopResize);
    }

    // reply animation + sound when iframe informs parent
    window.addEventListener("message", (ev) => {
      // only accept messages with type 'gemini_reply'
      if (!ev.data || ev.data.type !== "gemini_reply") return;
      // add class to animate
      popup.classList.add("reply-anim");
      setTimeout(() => popup.classList.remove("reply-anim"), 1200);

      // play chime
      playChime();
      // briefly show a small pulse on the button
      btn.animate([{ transform: 'scale(1)' }, { transform: 'scale(1.08)' }, { transform: 'scale(1)' }], { duration: 450, easing: 'ease' });
    });

    // Web Audio chime (no file)
    function playChime() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine';
        o.frequency.value = 880; // start freq
        g.gain.value = 0.0001;
        o.connect(g);
        g.connect(ctx.destination);
        const now = ctx.currentTime;
        // short chirp
        g.gain.setValueAtTime(0.0001, now);
        g.gain.exponentialRampToValueAtTime(0.06, now + 0.02);
        o.frequency.setValueAtTime(880, now);
        o.frequency.exponentialRampToValueAtTime(1320, now + 0.08);
        g.gain.exponentialRampToValueAtTime(0.0001, now + 0.35);
        o.start(now);
        o.stop(now + 0.38);
      } catch (e) {
        // ignore if audio not allowed
        console.warn("Audio play failed", e);
      }
    }

    // Optional: close if clicked outside (but keep button clickable)
    document.addEventListener("click", (ev) => {
      if (!popup.contains(ev.target) && !btn.contains(ev.target)) {
        // keep hidden only if open
        // popup.style.display = "none";
      }
    });

    // Expose a small API for debugging:
    window.__chatbotPopup = { open: () => popup.style.display = "block", close: () => popup.style.display = "none" };
  })();
   const chatbox = document.getElementById("chatbox");
  const typing = document.getElementById("typing");
  const previewDiv = document.getElementById("preview");
  let capturedImage = null;

  async function sendMessage() {
    const input = document.getElementById("userInput");
    const message = input.value.trim();
    if (!message && !capturedImage) return;

    // show user message
    const userDiv = document.createElement("div");
    userDiv.className = "msg user";
    userDiv.textContent = message || "[üì∏ Image]";
    chatbox.appendChild(userDiv);
    chatbox.scrollTop = chatbox.scrollHeight;

    input.value = "";
    previewDiv.innerHTML = "";
    typing.style.display = "block";

    try {
      const res = await fetch("/chatbot_api", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message, image: capturedImage })
      });
      const data = await res.json();
      typing.style.display = "none";

      const botDiv = document.createElement("div");
      botDiv.className = "msg bot";
      botDiv.textContent = data.response;
      chatbox.appendChild(botDiv);
      chatbox.scrollTop = chatbox.scrollHeight;

      // Notify parent window so it can animate and play sound
      if (window.parent) {
        window.parent.postMessage({ type: "gemini_reply", text: data.response }, "*");
      }
    } catch (err) {
      typing.style.display = "none";
      const errDiv = document.createElement("div");
      errDiv.className = "msg bot";
      errDiv.textContent = "‚ö†Ô∏è Error sending request.";
      chatbox.appendChild(errDiv);
      chatbox.scrollTop = chatbox.scrollHeight;
    } finally {
      capturedImage = null;
    }
  }

</script>

</body>
</html>
